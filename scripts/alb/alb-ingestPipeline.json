{
  "description" : "Ingest pipeline for AWS ALB Access Logs",
  "processors" : [
    {
      "grok": {
        "field": "message",
        "patterns":
          [
            "%{DATA:connection_type} %{TIMESTAMP_ISO8601:timestamp} %{DATA:alb_node} %{IP_PORT:client_ip_port} %{IP_PORT:target_ip_port} %{LATENCY:request_processing_time} %{LATENCY:target_processing_time} %{LATENCY:response_processing_time} %{DATA:alb_status_code} %{DATA:target_status_code} %{NONNEGINT:received_bytes} %{NONNEGINT:sent_bytes} ::%{REQUEST:request}:: ::%{GREEDYDATA:agent}:: %{DATA:ssl_cipher} %{GREEDYDATA:ssl_protocol} %{DATA:target_group_arn} ::%{DATA:trace_id}::"
          ],
        "pattern_definitions":
          {
            "NONVALID_FIELD" : "-",
            "NONVALID_NEGING_FIELD" : "-1",
            "VALID_IP_PORT" : "%{IPV4}:%{NUMBER}",
            "IP_PORT" : "%{VALID_IP_PORT}|%{NONVALID_FIELD}|%{DATA}",
            "LATENCY" : "%{BASE10NUM}|%{NONVALID_NEGING_FIELD}",
            "TCP_REQUEST" : "- - - ",
            "REQUEST" : "%{TCP_REQUEST}|%{GREEDYDATA}"
          }
      }
    },
    {
      "grok": {
        "field": "client_ip_port",
        "ignore_missing": true,
        "patterns":
          [
            "%{IPV4:client_ip_adress}:%{NUMBER:client_port}", "-", ""
          ]
      }
    },
    {
      "grok": {
        "field": "target_ip_port",
        "ignore_missing": true,
        "patterns":
          [
            "%{IPV4:target_ip_adress}:%{NUMBER:target_port}", "-", "%{DATA:target_group_name}", ""
          ]
      }
    },
    {
      "grok": {
        "field": "request",
        "ignore_missing": true,
        "patterns":
          [
            "^%{WORD:request_verb} %{GREEDYDATA:request_url} %{DATA:request_proto}$", "- - - ", "-", ""
          ]
      }
    },
    {
      "geoip": {
        "field": "client_ip_adress",
        "ignore_missing": true
      }
    },
    {
      "user_agent": {
        "field": "agent",
        "ignore_missing": true
      }
    },
    {
      "gsub": {
        "field": "request_processing_time",
        "pattern": "-1",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "target_processing_time",
        "pattern": "-1",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "response_processing_time",
        "pattern": "-1",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "alb_status_code",
        "pattern": "-",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "target_status_code",
        "pattern": "-",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "request",
        "pattern": "- - - ",
        "replacement": ""
      }
    },
    {
      "gsub": {
        "field": "agent",
        "pattern": "-",
        "replacement": ""
      }
    },
    {
      "gsub": {
        "field": "ssl_cipher",
        "pattern": "-",
        "replacement": ""
      }
    },
    {
      "gsub": {
        "field": "ssl_protocol",
        "pattern": "-",
        "replacement": ""
      }
    },
    {
      "gsub": {
        "field": "target_group_arn",
        "pattern": "-",
        "replacement": ""
      }
    },
    {
      "gsub": {
        "field": "trace_id",
        "pattern": "-",
        "replacement": ""
      }
    },
    {
      "remove": {
        "field": "client_ip_port"
      }
    },
    {
      "remove": {
        "field": "target_ip_port"
      }
    }
  ]
}
