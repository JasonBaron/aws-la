{
  "description" : "Ingest pipeline for AWS ELB Access Logs",
  "processors" : [
    {
      "grok": {
        "field": "message",
        "patterns":
          [
            "%{TIMESTAMP_ISO8601:timestamp} %{DATA:elb_node} %{IP_PORT:client_ip_port} %{IP_PORT:backend_ip_port} %{LATENCY:request_processing_time} %{LATENCY:backend_processing_time} %{LATENCY:response_processing_time} %{DATA:elb_status_code} %{DATA:backend_status_code} %{NONNEGINT:received_bytes} %{NONNEGINT:sent_bytes} ::%{REQUEST:request}:: ::%{GREEDYDATA:agent}:: %{DATA:ssl_cipher} %{GREEDYDATA:ssl_protocol}"
          ],
        "pattern_definitions":
          {
            "NONVALID_FIELD" : "-",
            "NONVALID_NEGING_FIELD" : "-1",
            "VALID_IP_PORT" : "%{IPV4}:%{NUMBER}",
            "IP_PORT" : "%{VALID_IP_PORT}|%{NONVALID_FIELD}",
            "LATENCY" : "%{BASE10NUM}|%{NONVALID_NEGING_FIELD}",
            "TCP_REQUEST" : "- - - ",
            "REQUEST" : "%{TCP_REQUEST}|%{GREEDYDATA}"
          }
      }
    },
    {
      "grok": {
        "field": "client_ip_port",
        "ignore_missing": true,
        "patterns":
          [
            "%{IPV4:client_ip_adress}:%{NUMBER:client_port}", "-", ""
          ]
      }
    },
    {
      "grok": {
        "field": "backend_ip_port",
        "ignore_missing": true,
        "patterns":
          [
            "%{IPV4:backend_ip_adress}:%{NUMBER:backend_port}", "-", ""
          ]
      }
    },
    {
      "grok": {
        "field": "request",
        "ignore_missing": true,
        "patterns":
          [
            "^%{WORD:request_verb} %{GREEDYDATA:request_url} %{DATA:request_proto}$", "- - - ", ""
          ]
      }
    },
    {
      "geoip": {
        "field": "client_ip_adress",
        "ignore_missing": true
      }
    },
    {
      "user_agent": {
        "field": "agent",
        "ignore_missing": true
      }
    },
    {
      "gsub": {
        "field": "request_processing_time",
        "pattern": "-1",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "backend_processing_time",
        "pattern": "-1",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "response_processing_time",
        "pattern": "-1",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "elb_status_code",
        "pattern": "-",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "backend_status_code",
        "pattern": "-",
        "replacement": "0"
      }
    },
    {
      "gsub": {
        "field": "request",
        "pattern": "- - - ",
        "replacement": ""
      }
    },
    {
      "gsub": {
        "field": "agent",
        "pattern": "-",
        "replacement": ""
      }
    },
    {
      "gsub": {
        "field": "ssl_cipher",
        "pattern": "-",
        "replacement": ""
      }
    },
    {
      "gsub": {
        "field": "ssl_protocol",
        "pattern": "-",
        "replacement": ""
      }
    },
    {
      "convert": {
        "field" : "elb_status_code",
        "type": "integer"
      }
    },
    {
      "convert": {
        "field" : "backend_status_code",
        "type": "integer"
      }
    },
    {
      "remove": {
        "field": "client_ip_port"
      }
    },
    {
      "remove": {
        "field": "backend_ip_port"
      }
    }
  ]
}
